<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title id="pageTitle">æ©Ÿæ§‹æ¨¡æ“¬å·¥å…·</title>
    <link rel="stylesheet" href="css/styles.css" />
    <style>
        #svgWrap,
        #partsWrap {
            background: #fafafa;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>

<body>
    <div class="nav-header">
        <div class="nav-content">
            <div>
                <a href="index.html" class="nav-back">
                    <span style="font-size: 20px;">â†</span>
                    <span>è¿”å›æ©Ÿæ§‹é¸å–®</span>
                </a>
            </div>
            <h2 class="nav-title">
                <span id="mechIcon">ğŸ”—</span>
                <span id="mechName">æ©Ÿæ§‹è¨­è¨ˆ</span>
            </h2>
            <div id="mechSelectorContainer"></div>
        </div>
    </div>

    <!-- Toggle & Tools Header (Mobile Only) -->
    <div style="height:10px"></div>
    <div class="row">
        <!-- Left Panel -->
        <div class="card" id="leftPanel" style="min-width: 380px; max-width: 380px;">
            <!-- Motor Sync Dashboard (Digital Twin Panel) -->
            <div id="motorSyncPanel"
                style="margin-bottom: 20px; padding: 12px; background: #fff; border: 1px solid #eee; border-radius: 8px; border-left: 4px solid #3498db; display: none;">
                <h3
                    style="margin-top:0; border:none; padding:0; display: flex; align-items: center; justify-content: space-between;">
                    <span>ğŸ“¡ é¦¬é”åŒæ­¥é¢æ¿</span>
                    <span id="remoteStatusBadge"
                        style="font-size: 10px; background: #f1f2f6; padding: 2px 6px; border-radius: 10px; color: #666; font-weight: normal;">OFFLINE</span>
                </h3>

                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: #666;">ç›®æ¨™é¦¬é”æº (Target Source)</label>
                    <div style="display: flex; gap: 4px; margin-top: 4px;">
                        <button class="motor-btn active" data-id="1">M1</button>
                        <button class="motor-btn" data-id="2">M2</button>
                        <button class="motor-btn" data-id="3">M3</button>
                        <button class="motor-btn" data-id="4">M4</button>
                    </div>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <div>
                        <label style="font-size: 11px; margin-bottom: 2px; display:block;">æŒ‡ä»¤ä½ç½® (Target)</label>
                        <div id="valTargetDeg"
                            style="font-size: 18px; font-weight: bold; font-family: monospace; color: #e67e22;">---
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 11px; margin-bottom: 2px; display:block;">å¯¦æ¸¬è§’åº¦ (DEG)</label>
                        <div id="valDeg"
                            style="font-size: 18px; font-weight: bold; font-family: monospace; color: #2c3e50;">0.0Â°
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 11px; margin-bottom: 2px; display:block;">å¯¦æ¸¬è½‰é€Ÿ (RPM)</label>
                        <div id="valRpm"
                            style="font-size: 18px; font-weight: bold; font-family: monospace; color: #2c3e50;">0.0
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="font-size: 11px; display: flex; justify-content: space-between;">
                        <span>PWM è² è¼‰</span>
                        <span id="valPwmText">0%</span>
                    </label>
                    <div style="height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 4px;">
                        <div id="valPwmBar"
                            style="height: 100%; width: 0%; background: linear-gradient(90deg, #3498db, #2ecc71); transition: width 0.2s;">
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button id="btnSetZero"
                        style="flex: 1; padding: 6px; font-size: 12px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">è§’åº¦æ ¡é›¶</button>
                    <label
                        style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 12px; background: #f8f9fa; border-radius: 4px; cursor: pointer; border: 1px solid #ddd;">
                        <input id="chkSyncMotor" type="checkbox" />
                        <span>è¿½éš¨ç¡¬é«”</span>
                    </label>
                </div>

                <style>
                    .motor-btn {
                        flex: 1;
                        padding: 4px 0;
                        border: 1px solid #ddd;
                        background: white;
                        cursor: pointer;
                        border-radius: 4px;
                        font-size: 12px;
                        transition: all 0.2s;
                    }

                    .motor-btn.active {
                        background: #3498db;
                        color: white;
                        border-color: #2980b9;
                        font-weight: bold;
                    }

                    .motor-btn:hover:not(.active) {
                        background: #f8f9fa;
                    }
                </style>
            </div>

            <div id="wizardContainer"></div>
            <div id="parametersPanel"></div>

            <div style="height:10px"></div>
            <h3>é›¶ä»¶è¦æ ¼</h3>
            <div id="partSpecsPanel"></div>

            <div style="height:10px"></div>
            <h3>åŠ å·¥è¨­å®šï¼ˆGRBL / 3018ï¼‰</h3>
            <div class="grid">
                <div>
                    <label>å·¥ä½œç¯„åœ Xï¼ˆmmï¼‰</label>
                    <input id="workX" type="number" value="300" />
                </div>
                <div>
                    <label>å·¥ä½œç¯„åœ Yï¼ˆmmï¼‰</label>
                    <input id="workY" type="number" value="180" />
                </div>
                <div>
                    <label>åˆ€å¾‘ï¼ˆmmï¼‰</label>
                    <input id="toolD" type="number" min="0.5" max="10" step="0.1" value="3.0" />
                </div>
                <div>
                    <label>å­”åŠ å·¥æ–¹å¼</label>
                    <select id="holeMode">
                        <option value="drill">é‘½ä¸­å¿ƒé»</option>
                        <option value="mill">éŠ‘å…§å¾‘</option>
                    </select>
                </div>
                <div>
                    <label>ææ–™åšåº¦ Tï¼ˆmmï¼‰</label>
                    <input id="thickness" type="number" min="1" max="30" step="0.1" value="3.0" />
                </div>
                <div>
                    <label>ç©¿é€é¤˜é‡ï¼ˆmmï¼‰</label>
                    <input id="overcut" type="number" min="0" max="2" step="0.1" value="0.5" />
                </div>
                <div>
                    <label>æ¯å±¤ä¸‹åˆ€ï¼ˆmmï¼‰</label>
                    <input id="stepdown" type="number" min="0.1" max="5" step="0.1" value="0.5" />
                </div>
                <div>
                    <label>SAFE_Zï¼ˆmmï¼‰</label>
                    <input id="safeZ" type="number" min="1" max="30" step="0.5" value="5" />
                </div>
                <div>
                    <label>Feed XYï¼ˆmm/minï¼‰</label>
                    <input id="feedXY" type="number" min="50" max="3000" step="10" value="400" />
                </div>
                <div>
                    <label>Feed Zï¼ˆmm/minï¼‰</label>
                    <input id="feedZ" type="number" min="30" max="2000" step="10" value="100" />
                </div>
                <div>
                    <label>Tab thickness (mm)</label>
                    <input id="tabThickness" type="number" min="0" max="5" step="0.1" value="1.1" />
                </div>
                <div>
                    <label>Tab width (mm)</label>
                    <input id="tabWidth" type="number" min="0" max="10" step="0.1" value="2" />
                </div>
                <div>
                    <label>Tab count</label>
                    <input id="tabCount" type="number" min="0" max="20" step="1" value="4" />
                </div>
                <div>
                    <label>ä¸»è»¸ Sï¼ˆå¯ç©ºç™½ï¼‰</label>
                    <input id="spindle" type="number" min="1000" max="30000" step="100" placeholder="ä¾‹å¦‚ 12000" />
                </div>
            </div>

            <div class="btnrow">
                <button id="btnGen">ç”Ÿæˆ G-code</button>
            </div>

            <div style="height:10px"></div>
            <div class="note">
                <div class="warn">æ³¨æ„ï¼šv0.1 ä¸å« tabsã€‚å¤–å½¢åˆ‡å®Œé›¶ä»¶å¯èƒ½é¬†è„«ï¼Œè«‹ç”¨é›™é¢è† /å£“æ¿å›ºå®šã€‚</div>
                <div>é è¨­ï¼šG21 / G90 / SAFE_Z å…ˆæŠ¬åˆ€ã€å…ˆé‘½å­”å¾Œå¤–å½¢ã€å¤šå±¤ stepdownã€‚</div>
            </div>

            <div style="height:10px"></div>
            <h3>è¼¸å‡º / è¨Šæ¯</h3>
            <div id="log" class="card" style="padding:10px; background:#fafafa;"></div>
            <div class="btnrow" id="dlButtons"></div>

        </div>

        <!-- Main Content (Sim + Right Panel) -->
        <div style="flex: 1; min-width: 0;">
            <div class="card"
                style="height: 100%; display: flex; flex-direction: column; padding: 0; overflow: hidden; min-height: 800px;">

                <!-- Toolbar -->
                <div
                    style="padding: 12px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; border:none; font-size: 16px;">2D æ¨¡æ“¬èˆ‡åƒæ•¸èª¿æ•´</h3>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <label style="font-size:12px; color:#555; display:flex; align-items:center; gap:6px;">
                            <input id="showPartsOverlay" type="checkbox" />
                            å¥—ç”¨é›¶ä»¶å¤–å½¢
                        </label>
                        <div style="height: 20px; width: 1px; background: #ddd; margin: 0 5px;"></div>
                        <div id="wsStatus"
                            style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: #777;">
                            <span id="wsDot"
                                style="width: 8px; height: 8px; background: #ccc; border-radius: 50%;"></span>
                            <span id="wsStatusText">é›¢ç·š</span>
                            <label
                                style="display:flex; align-items:center; gap:4px; cursor:pointer; margin-left: 4px; font-weight: bold; color: #2980b9;">
                                <input id="chkEnableRemote" type="checkbox" />
                                é–‹å•Ÿé ç«¯é€šè¨Š
                            </label>
                        </div>
                        <div style="height: 20px; width: 1px; background: #ddd; margin: 0 5px;"></div>
                        <button id="btnNewConfig" style="padding: 6px 12px; font-size: 14px;">æ–°æª”</button>
                        <button id="btnOpenConfig" style="padding: 6px 12px; font-size: 14px;">é–‹å•Ÿ</button>
                        <button id="btnSaveConfig" style="padding: 6px 12px; font-size: 14px;">å­˜æª”</button>
                        <button class="primary" id="btnUpdate" style="padding: 6px 12px; font-size: 14px;">æ›´æ–° /
                            é è¦½</button>
                    </div>
                </div>
                <input id="configFileInput" type="file" accept="application/json,.json" style="display:none" />

                <!-- Split View: Sim + Right Panel -->
                <div style="display:flex; flex:1; overflow:hidden; position: relative;">

                    <!-- Sim Area -->
                    <div style="flex: 1; overflow: hidden; background: #fff; display: flex; flex-direction: column;">
                        <div style="position: relative; flex: 1; overflow: hidden;">
                            <div id="svgWrap"
                                style="width: 100%; height: 100%; display: flex; justify-content: center; border: none;">
                            </div>
                            <div id="partsOverlayWrap"
                                style="position: absolute; inset: 0; pointer-events: none; opacity: 0.35; display: none; z-index: 20; transform-origin: center; align-items: center; justify-content: center;">
                            </div>

                            <!-- ğŸŒŸ å¹¾ä½•æ¥µé™è­¦å‘Šæ©«å¹… -->
                            <div id="invalidWarning"
                                style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: fit-content; max-width: calc(100% - 20px); background: rgba(231, 76, 60, 0.9); color: white; padding: 10px 14px; text-align: center; font-weight: bold; z-index: 1000; display: none; backdrop-filter: blur(4px); border-radius: 8px;">
                                âš ï¸ å¹¾ä½•æ¥µé™å·²é”ï¼šç•¶å‰é•·åº¦çµ„åˆåœ¨è©²è§’åº¦ä¸‹ä¸å¯è¡Œ
                            </div>

                            <!-- Overlay Controls -->
                            <div id="thetaSliderContainer"
                                style="position:absolute; top:10px; left:10px; padding:6px 10px; background:transparent; pointer-events: none; display: none;">
                                <div id="thetaSliderBlock">
                                    <div style="display:flex; align-items:center; gap:8px; pointer-events: auto;">
                                        <label for="thetaSlider"
                                            style="font-size:12px; color:#555; white-space:nowrap; font-weight:600;">Î¸</label>
                                        <input id="thetaSlider" type="range" min="-360" max="360" step="1" value="0"
                                            style="width:200px;" />
                                        <span id="thetaSliderValue"
                                            style="font-size:12px; color:#333; font-weight:600; min-width:40px; text-align:center;">0Â°</span>
                                    </div>
                                    <div
                                        style="display:flex; justify-content:space-between; margin-top:2px; padding-left:24px; width:200px;">
                                        <span id="thetaSliderMin" style="font-size:10px; color:#999;">-360Â°</span>
                                        <span id="thetaSliderMax" style="font-size:10px; color:#999;">360Â°</span>
                                    </div>
                                </div>
                                <div id="motorAngleContainer" style="display:none; pointer-events: auto;"></div>
                            </div>

                            <!-- Animation Controls -->
                            <div id="animControlPanel"
                                style="position: absolute; bottom: 30px; right: 15px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); padding: 12px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); z-index: 100; display: flex; flex-direction: column; gap: 8px; min-width: 260px;">
                                <div
                                    style="font-size: 12px; font-weight: bold; color: #666; margin-bottom: 2px; display: flex; align-items: center; gap: 4px;">
                                    <span>ğŸ¬</span> å‹•ç•«æ§åˆ¶
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="display: flex; gap: 6px;">
                                        <button id="btnPlayAnim" class="btn-play"
                                            style="width: 42px; height: 36px; border-radius: 8px; border: none; background: #2ecc71; color: white; font-weight: bold; cursor: pointer;">â–¶</button>
                                        <button id="btnPauseAnim" class="btn-pause"
                                            style="width: 42px; height: 36px; border-radius: 8px; border: none; background: #f1c40f; color: white; font-weight: bold; cursor: pointer;"
                                            disabled>â¸</button>
                                        <button id="btnStopAnim" class="btn-stop"
                                            style="width: 42px; height: 36px; border-radius: 8px; border: none; background: #e74c3c; color: white; font-weight: bold; cursor: pointer;"
                                            disabled>â¹</button>
                                    </div>
                                    <div
                                        style="display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.03); padding: 6px 8px; border-radius: 8px;">
                                        <label style="font-size: 12px; color: #444; white-space: nowrap;">é€Ÿåº¦</label>
                                        <input id="animSpeed" type="number" min="1" max="120" step="1" value="10"
                                            style="width: 54px; border: none; background: transparent; font-weight: bold; color: #2c3e50; outline: none;" />
                                        <span style="font-size: 11px; color: #666;">RPM</span>
                                    </div>
                                </div>
                            </div>
                            <div class="note"
                                style="position: absolute; bottom: 10px; width: 100%; text-align: center; pointer-events: none;"
                                id="simNotes"></div>
                        </div>

                        <!-- Parts Preview Panel (Bottom) -->
                        <div id="partsPreviewPanel" data-expanded-height="540px"
                            style="height: 540px; background: #fafafa; border-top: 1px solid #ddd; display: flex; flex-direction: column;">
                            <h4
                                style="margin:0; padding: 8px 12px; font-size: 14px; color: #555; background: #f1f2f6; border-bottom: 1px solid #eee;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span>é›¶ä»¶æ’ç‰ˆé è¦½</span>
                                    <label
                                        style="font-size:12px; color:#666; display:flex; align-items:center; gap:6px;">
                                        <input id="showPartsPreview" type="checkbox" />
                                        é¡¯ç¤º
                                    </label>
                                </div>
                            </h4>
                            <div id="partsPreviewBody"
                                style="flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column;">
                                <div id="partsWrap"
                                    style="flex: 1; width: 100%; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 10px;">
                                </div>
                                <div class="note"
                                    style="padding: 6px 12px; background: #fff; border-top: 1px solid #eee; font-size: 12px; color: #888;">
                                    â„¹ï¸ é›¶ä»¶æ’ç‰ˆåœ¨å·¥ä½œå€ï¼ˆ0..X, 0..Yï¼‰ï¼Œæ¯æ ¹å„è‡ªè¼¸å‡ºä¸€ä»½ G-codeã€‚
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel (Dynamic Params) -->
                    <div id="rightParamsPanel"
                        style="position: absolute; top: 10px; right: 10px; width: 320px; height: calc(100% - 20px); background: transparent; border: none; padding: 0; display: flex; flex-direction: column; gap: 6px; z-index: 200; pointer-events: none;">
                        <div
                            style="pointer-events: auto; display: flex; flex-direction: column; gap: 6px; max-height: 100%; overflow-y: auto; padding: 0 6px 6px;">
                            <div style="display:flex; justify-content:flex-end; align-items:center; gap:6px;">
                                <label for="viewRangeSlider"
                                    style="font-size:12px; color:#555; white-space:nowrap;">Range</label>
                                <input id="viewRangeSlider" type="range" min="50" max="2000" step="10" value="800"
                                    style="width:160px;" />
                                <span id="viewRangeSliderValue"
                                    style="font-size:12px; color:#333; min-width:48px; text-align:right;">800</span>
                            </div>
                            <h4
                                style="margin: 0; font-size: 14px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                                ğŸ“ æ¡¿ä»¶å¹¾ä½•å‹•æ…‹èª¿æ•´</h4>
                            <div id="dynamicParamsContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Bottom Sheet (Overlay for Zen Mode / Selection) -->
    <div id="propertySheet" class="bottom-sheet" style="display: none;">
        <div class="sheet-header">
            <h4 style="margin:0;">ğŸ“ æ¡¿ä»¶å±¬æ€§</h4>
            <button id="btnCloseProp"
                style="font-size:24px; cursor:pointer; background:transparent; border:none;  margin-left: auto;">âœ•</button>
        </div>

        <div id="sheetContent" style="padding: 10px; max-height: 250px; overflow-y: auto;">
            <div style="color: #666; font-size:14px; text-align:center; padding: 20px;" id="emptyPropMsg">
                é¸å–ç‰©ä»¶ä»¥ç·¨è¼¯
            </div>
            <!-- Dynamic Controls will be injected here -->
        </div>

        <div class="sheet-actions"
            style="padding: 10px; border-top: 1px solid #eee; display: flex; justify-content: space-between;">
            <button id="btnDeleteLink"
                style="background: #e74c3c; color: white; padding: 10px 16px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; display: none;">ğŸ—‘ï¸
                åˆªé™¤ç‰©ä»¶</button>
            <button id="btnApplyProp" class="primary"
                style="padding: 10px 16px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">é—œé–‰</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script type="module" src="js/mechanism-loader.js?v=debug_1"></script>
    <script>
        // éæ¨¡çµ„é‚è¼¯ï¼šUI ä»‹é¢æ§åˆ¶
        window.addEventListener('DOMContentLoaded', () => {
            const btnCloseProp = document.getElementById('btnCloseProp');
            const btnApplyProp = document.getElementById('btnApplyProp');
            const propertySheet = document.getElementById('propertySheet');

            const closeSheet = () => {
                if (propertySheet) {
                    propertySheet.classList.remove('open');
                    setTimeout(() => { propertySheet.style.display = 'none'; }, 300);
                }
            };

            if (btnCloseProp) btnCloseProp.onclick = closeSheet;
            if (btnApplyProp) btnApplyProp.onclick = closeSheet;
        });
    </script>
    <script>
        (function setupLeftPanelSections() {
            const panel = document.getElementById('leftPanel');
            if (!panel) return;

            const wrapHeading = (heading) => {
                if (!heading || heading.dataset.sectionWrapped === '1') return;
                if (heading.closest('.left-section')) return;
                const titleText = (heading.textContent || '').trim();
                if (heading.closest('#wizardContainer')) return;
                if (titleText.includes('æ©Ÿæ§‹è¨­è¨ˆå™¨') || titleText.includes('è¼¸å‡º / è¨Šæ¯')) return;

                const section = document.createElement('div');
                section.className = 'left-section';

                const header = document.createElement('div');
                header.className = 'left-section-header';

                const toggle = document.createElement('span');
                toggle.className = 'left-section-toggle';
                toggle.textContent = '+';

                const title = document.createElement('span');
                title.textContent = heading.textContent;

                header.appendChild(toggle);
                header.appendChild(title);

                const body = document.createElement('div');
                body.className = 'left-section-body';

                let next = heading.nextSibling;
                while (next && !(next.nodeType === 1 && (next.tagName === 'H3' || next.tagName === 'H4'))) {
                    const curr = next;
                    next = next.nextSibling;
                    body.appendChild(curr);
                }

                section.appendChild(header);
                section.appendChild(body);
                heading.dataset.sectionWrapped = '1';
                heading.replaceWith(section);

                section.classList.add('collapsed');

                header.addEventListener('click', () => {
                    const collapsed = section.classList.toggle('collapsed');
                    toggle.textContent = collapsed ? '+' : '-';
                });
            };

            const refresh = () => {
                const headings = Array.from(panel.querySelectorAll('h3, h4'));
                headings.forEach(wrapHeading);
            };

            refresh();

            const observer = new MutationObserver(() => {
                refresh();
            });
            observer.observe(panel, { childList: true, subtree: true });
        })();
    </script>
</body>

</html>
