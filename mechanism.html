<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title id="pageTitle">機構模擬工具</title>
    <link rel="stylesheet" href="css/styles.css" />
    <style>
        #svgWrap,
        #partsWrap {
            background: #fff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>

<body>
    <div class="nav-header">
        <div class="nav-content">
            <div>
                <a href="index.html" class="nav-back">
                    <span style="font-size: 20px;">←</span>
                    <span>返回機構選單</span>
                </a>
            </div>
            <h2 class="nav-title">
                <span id="mechIcon">🔗</span>
                <span id="mechName">機構設計</span>
            </h2>
            <div id="mechSelectorContainer"></div>
        </div>
    </div>

    <!-- Toggle & Tools Header (Mobile Only) -->
    <div class="mobile-only" style="padding: 0 16px 16px 16px; display: none;">
        <button id="btnToggleSettings" class="primary" style="margin-bottom: 10px;">⚙️ 設定與參數</button>
    </div>

    <div class="row">
        <!-- Left Panel -->
        <div class="card" id="leftPanel" style="min-width: 380px; max-width: 380px;">
            <div id="parametersPanel"></div>

            <div style="height:10px"></div>
            <h3>零件規格</h3>
            <div id="partSpecsPanel"></div>

            <div style="height:10px"></div>
            <h3>加工設定（GRBL / 3018）</h3>
            <div class="grid">
                <div>
                    <label>工作範圍 X（mm）</label>
                    <input id="workX" type="number" value="300" />
                </div>
                <div>
                    <label>工作範圍 Y（mm）</label>
                    <input id="workY" type="number" value="180" />
                </div>
                <div>
                    <label>刀徑（mm）</label>
                    <input id="toolD" type="number" min="0.5" max="10" step="0.1" value="3.0" />
                </div>
                <div>
                    <label>孔加工方式</label>
                    <select id="holeMode">
                        <option value="drill">鑽中心點</option>
                        <option value="mill">銑內徑</option>
                    </select>
                </div>
                <div>
                    <label>材料厚度 T（mm）</label>
                    <input id="thickness" type="number" min="1" max="30" step="0.1" value="3.0" />
                </div>
                <div>
                    <label>穿透餘量（mm）</label>
                    <input id="overcut" type="number" min="0" max="2" step="0.1" value="0.5" />
                </div>
                <div>
                    <label>每層下刀（mm）</label>
                    <input id="stepdown" type="number" min="0.1" max="5" step="0.1" value="0.5" />
                </div>
                <div>
                    <label>SAFE_Z（mm）</label>
                    <input id="safeZ" type="number" min="1" max="30" step="0.5" value="5" />
                </div>
                <div>
                    <label>Feed XY（mm/min）</label>
                    <input id="feedXY" type="number" min="50" max="3000" step="10" value="400" />
                </div>
                <div>
                    <label>Feed Z（mm/min）</label>
                    <input id="feedZ" type="number" min="30" max="2000" step="10" value="100" />
                </div>
                <div>
                    <label>主軸 S（可空白）</label>
                    <input id="spindle" type="number" min="1000" max="30000" step="100" placeholder="例如 12000" />
                </div>
            </div>

            <div class="btnrow">
                <button id="btnGen">生成 G-code</button>
            </div>

            <div style="height:10px"></div>
            <div class="note">
                <div class="warn">注意：v0.1 不含 tabs。外形切完零件可能鬆脫，請用雙面膠/壓板固定。</div>
                <div>預設：G21 / G90 / SAFE_Z 先抬刀、先鑽孔後外形、多層 stepdown。</div>
            </div>

            <div style="height:10px"></div>
            <h3>輸出 / 訊息</h3>
            <div id="log" class="card" style="padding:10px; background:#fafafa;"></div>
            <div class="btnrow" id="dlButtons"></div>

        </div>

        <!-- Main Content (Sim + Right Panel) -->
        <div style="flex: 1; min-width: 0;">
            <div class="card"
                style="height: 100%; display: flex; flex-direction: column; padding: 0; overflow: hidden; min-height: 800px;">

                <!-- Toolbar -->
                <div
                    style="padding: 12px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; border:none; font-size: 16px;">2D 模擬與參數調整</h3>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button id="btnNewConfig" style="padding: 6px 12px; font-size: 14px;">新檔</button>
                        <button id="btnOpenConfig" style="padding: 6px 12px; font-size: 14px;">開啟</button>
                        <button id="btnSaveConfig" style="padding: 6px 12px; font-size: 14px;">存檔</button>
                        <button class="primary" id="btnUpdate" style="padding: 6px 12px; font-size: 14px;">更新 /
                            預覽</button>
                    </div>
                </div>
                <input id="configFileInput" type="file" accept="application/json,.json" style="display:none" />

                <!-- Split View: Sim + Right Panel -->
                <div style="display:flex; flex:1; overflow:hidden;">

                    <!-- Sim Area -->
                    <div style="flex: 1; overflow: hidden; background: #fff; display: flex; flex-direction: column;">
                        <div style="position: relative; flex: 1; overflow: hidden;">
                            <div id="svgWrap"
                                style="width: 100%; height: 100%; display: flex; justify-content: center; border: none;">
                            </div>

                            <!-- Overlay Controls -->
                            <div id="thetaSliderContainer"
                                style="position:absolute; top:10px; left:10px; padding:6px 10px; background:transparent; pointer-events: none; display: none;">
                                <div style="display:flex; align-items:center; gap:8px; pointer-events: auto;">
                                    <label for="thetaSlider"
                                        style="font-size:12px; color:#555; white-space:nowrap; font-weight:600;">θ</label>
                                    <input id="thetaSlider" type="range" min="-360" max="360" step="1" value="0"
                                        style="width:200px;" />
                                    <span id="thetaSliderValue"
                                        style="font-size:12px; color:#333; font-weight:600; min-width:40px; text-align:center;">0°</span>
                                </div>
                                <div
                                    style="display:flex; justify-content:space-between; margin-top:2px; padding-left:24px; width:200px;">
                                    <span id="thetaSliderMin" style="font-size:10px; color:#999;">-360°</span>
                                    <span id="thetaSliderMax" style="font-size:10px; color:#999;">360°</span>
                                </div>
                            </div>
                            <div
                                style="position:absolute; top:10px; right:10px; display:flex; align-items:center; gap:6px; padding:4px 8px; background:transparent; pointer-events: none;">
                                <div style="pointer-events: auto;">
                                    <label for="viewRangeSlider"
                                        style="font-size:12px; color:#555; white-space:nowrap;">Range</label>
                                    <input id="viewRangeSlider" type="range" min="50" max="2000" step="10" value="800"
                                        style="width:160px;" />
                                    <span id="viewRangeSliderValue"
                                        style="font-size:12px; color:#333; min-width:48px; text-align:right;">800</span>
                                </div>
                            </div>

                            <!-- Animation Controls -->
                            <div id="animControlPanel"
                                style="position: absolute; bottom: 30px; right: 15px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); padding: 12px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); z-index: 100; display: flex; flex-direction: column; gap: 8px; min-width: 200px;">
                                <div
                                    style="font-size: 12px; font-weight: bold; color: #666; margin-bottom: 2px; display: flex; align-items: center; gap: 4px;">
                                    <span>🎬</span> 動畫控制
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="display: flex; gap: 6px;">
                                        <button id="btnPlayAnim" class="btn-play"
                                            style="width: 42px; height: 36px; border-radius: 8px; border: none; background: #2ecc71; color: white; font-weight: bold; cursor: pointer;">▶</button>
                                        <button id="btnPauseAnim" class="btn-pause"
                                            style="width: 42px; height: 36px; border-radius: 8px; border: none; background: #f1c40f; color: white; font-weight: bold; cursor: pointer;"
                                            disabled>⏸</button>
                                        <button id="btnStopAnim" class="btn-stop"
                                            style="width: 42px; height: 36px; border-radius: 8px; border: none; background: #e74c3c; color: white; font-weight: bold; cursor: pointer;"
                                            disabled>⏹</button>
                                    </div>
                                    <div
                                        style="display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.03); padding: 6px 8px; border-radius: 8px;">
                                        <label style="font-size: 12px; color: #444; white-space: nowrap;">速度</label>
                                        <input id="animSpeed" type="number" min="1" max="120" step="1" value="10"
                                            style="width: 54px; border: none; background: transparent; font-weight: bold; color: #2c3e50; outline: none;" />
                                        <span style="font-size: 11px; color: #666;">RPM</span>
                                    </div>
                                </div>
                            </div>
                            <div class="note"
                                style="position: absolute; bottom: 10px; width: 100%; text-align: center; pointer-events: none;"
                                id="simNotes"></div>
                        </div>

                        <!-- Parts Preview Panel (Bottom) -->
                        <div
                            style="height: 500px; background: #fafafa; border-top: 1px solid #ddd; display: flex; flex-direction: column;">
                            <h4
                                style="margin:0; padding: 8px 12px; font-size: 14px; color: #555; background: #f1f2f6; border-bottom: 1px solid #eee;">
                                🧩 零件排版預覽
                            </h4>
                            <div
                                style="flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column;">
                                <div id="partsWrap"
                                    style="flex: 1; width: 100%; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 10px;">
                                </div>
                                <div class="note"
                                    style="padding: 6px 12px; background: #fff; border-top: 1px solid #eee; font-size: 12px; color: #888;">
                                    ℹ️ 零件排版在工作區（0..X, 0..Y），每根各自輸出一份 G-code。
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel (Dynamic Params) -->
                    <div id="rightParamsPanel"
                        style="width: 350px; background: #fcfcfc; border-left: 1px solid #eee; padding: 10px; display: flex; flex-direction: column; gap: 10px; overflow-y:auto;">
                        <h4
                            style="margin: 0; font-size: 14px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            📏 桿件長度動態調整</h4>
                        <div id="dynamicParamsContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Bottom Sheet (Overlay for Zen Mode / Selection) -->
    <div id="propertySheet" class="bottom-sheet" style="display: none;">
        <div class="sheet-header">
            <h4 style="margin:0;">📏 桿件屬性</h4>
            <button id="btnCloseProp"
                style="font-size:24px; cursor:pointer; background:transparent; border:none;  margin-left: auto;">✕</button>
        </div>

        <div id="sheetContent" style="padding: 10px; max-height: 250px; overflow-y: auto;">
            <div style="color: #666; font-size:14px; text-align:center; padding: 20px;" id="emptyPropMsg">
                選取物件以編輯
            </div>
            <!-- Dynamic Controls will be injected here -->
        </div>

        <div class="sheet-actions"
            style="padding: 10px; border-top: 1px solid #eee; display: flex; justify-content: space-between;">
            <button id="btnDeleteLink"
                style="background: #e74c3c; color: white; padding: 10px 16px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; display: none;">🗑️
                刪除物件</button>
            <button id="btnApplyProp" class="primary"
                style="padding: 10px 16px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">關閉</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script type="module">
        import(`./js/mechanism-loader.js?t=${Date.now()}`);

        document.getElementById('btnCloseProp').onclick = function () {
            const sheet = document.getElementById('propertySheet');
            sheet.classList.remove('open');
            setTimeout(() => { sheet.style.display = 'none'; }, 300);
        };

        document.getElementById('btnApplyProp').onclick = document.getElementById('btnCloseProp').onclick;
    </script>
</body>

</html>